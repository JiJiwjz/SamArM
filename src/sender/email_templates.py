"""
ÈÇÆ‰ª∂Ê®°Êùø
ÂÆö‰πâHTMLÈÇÆ‰ª∂ÁöÑÊ†∑ÂºèÂíåÁªìÊûÑ
"""

from datetime import datetime


class EmailTemplate:
    """ÈÇÆ‰ª∂Ê®°ÊùøÁ±ª"""
    
    @staticmethod
    def get_header(date_str: str, total_papers: int, topic_stats: dict = None) -> str:
        """
        ÁîüÊàêÈÇÆ‰ª∂Â§¥ÈÉ®
        
        Args:
            date_str: Êó•ÊúüÂ≠óÁ¨¶‰∏≤
            total_papers: ËÆ∫ÊñáÊÄªÊï∞
            topic_stats: ‰∏ªÈ¢òÁªüËÆ°Â≠óÂÖ∏
        
        Returns:
            HTMLÂ§¥ÈÉ®
        """
        topic_html = ""
        if topic_stats:
            topic_html = "<tr><td style='padding: 10px 0;'><strong>üìä ‰∏ªÈ¢òÂàÜÂ∏ÉÔºö</strong> "
            for topic, count in sorted(topic_stats.items(), key=lambda x: x[1], reverse=True):
                topic_html += f"{topic}: {count}ÁØá | "
            topic_html = topic_html.rstrip(" | ") + "</td></tr>"
        
        return f"""
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÄêArxivËÆ∫ÊñáÊó•Êä•„Äë{date_str}</title>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }}
        
        .container {{
            max-width: 800px;
            margin: 0 auto;
            background-color: #ffffff;
        }}
        
        .header {{
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }}
        
        .header h1 {{
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }}
        
        .header p {{
            font-size: 14px;
            opacity: 0.9;
        }}
        
        .info-box {{
            background-color: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            margin: 20px 30px;
            font-size: 13px;
            line-height: 1.8;
        }}
        
        .info-box strong {{
            color: #667eea;
        }}
        
        .content {{
            padding: 0 30px 30px 30px;
        }}
        
        .paper-card {{
            background-color: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }}
        
        .paper-card:hover {{
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }}
        
        .paper-number {{
            display: inline-block;
            background-color: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }}
        
        .paper-title {{
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 10px 0;
            line-height: 1.4;
        }}
        
        .paper-title a {{
            color: #667eea;
            text-decoration: none;
        }}
        
        .paper-title a:hover {{
            text-decoration: underline;
        }}
        
        .paper-meta {{
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            font-size: 12px;
            color: #666;
            margin: 10px 0;
        }}
        
        .paper-meta span {{
            display: flex;
            align-items: center;
        }}
        
        .paper-meta strong {{
            color: #333;
            margin-right: 5px;
        }}
        
        .paper-authors {{
            font-size: 13px;
            color: #555;
            margin: 8px 0;
            font-style: italic;
        }}
        
        .paper-topic {{
            display: inline-block;
            background-color: #e8f0fe;
            color: #667eea;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }}
        
        .paper-score {{
            display: inline-block;
            background-color: #fff3e0;
            color: #f57c00;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }}
        
        .quality-badge {{
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }}
        
        .quality-top {{
            background-color: #fff3e0;
            color: #e65100;
        }}
        
        .quality-excellent {{
            background-color: #e8f5e9;
            color: #2e7d32;
        }}
        
        .quality-good {{
            background-color: #e3f2fd;
            color: #1565c0;
        }}
        
        .quality-normal {{
            background-color: #f3e5f5;
            color: #6a1b9a;
        }}
        
        .quality-weak {{
            background-color: #fafafa;
            color: #757575;
        }}
        
        .paper-summary {{
            background-color: #ffffff;
            border-left: 3px solid #667eea;
            padding: 12px 15px;
            margin: 12px 0;
            font-size: 13px;
            line-height: 1.7;
            color: #555;
        }}
        
        .quality-reasoning {{
            background-color: #fffef7;
            border-left: 3px solid #ffa726;
            padding: 10px 15px;
            margin: 12px 0;
            font-size: 12px;
            line-height: 1.6;
            color: #666;
            font-style: italic;
        }}
        
        .paper-keywords {{
            font-size: 12px;
            color: #999;
            margin: 10px 0;
        }}
        
        .paper-keywords strong {{
            color: #666;
        }}
        
        .paper-link {{
            display: inline-block;
            background-color: #667eea;
            color: white;
            padding: 6px 14px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
            transition: background-color 0.3s;
        }}
        
        .paper-link:hover {{
            background-color: #764ba2;
        }}
        
        .footer {{
            background-color: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            padding: 20px 30px;
            font-size: 12px;
            color: #999;
            text-align: center;
        }}
        
        .footer a {{
            color: #667eea;
            text-decoration: none;
        }}
        
        .divider {{
            height: 1px;
            background-color: #e0e0e0;
            margin: 20px 0;
        }}
        
        @media only screen and (max-width: 600px) {{
            .container {{
                width: 100%;
            }}
            
            .header {{
                padding: 30px 20px;
            }}
            
            .header h1 {{
                font-size: 22px;
            }}
            
            .content {{
                padding: 0 20px 20px 20px;
            }}
            
            .info-box {{
                margin: 15px 20px;
                padding: 12px 15px;
                font-size: 12px;
            }}
            
            .paper-card {{
                padding: 15px;
                margin-bottom: 15px;
            }}
            
            .paper-meta {{
                gap: 10px;
                font-size: 11px;
            }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö ArxivËÆ∫ÊñáÊó•Êä•</h1>
            <p>{date_str}</p>
        </div>
        
        <div class="info-box">
            <table style="width: 100%; border-collapse: collapse;">
                <tr><td style="padding: 5px 0;"><strong>üìä ÊÄªËÆ∫ÊñáÊï∞Ôºö</strong> {total_papers} ÁØá</td></tr>
                {topic_html}
            </table>
        </div>
        
        <div class="content">
"""

    @staticmethod
    def get_paper_card(index: int, paper: dict) -> str:
        """
        ÁîüÊàêÂçïÁØáËÆ∫ÊñáÁöÑÂç°ÁâáHTML
        
        Args:
            index: ËÆ∫ÊñáÂ∫èÂè∑
            paper: ËÆ∫Êñá‰ø°ÊÅØÂ≠óÂÖ∏ÔºàÂåÖÂê´AIÊÄªÁªìÂíåËØÑ‰º∞Ôºâ
        
        Returns:
            HTMLÂç°Áâá
        """
        # ÊèêÂèñ‰ø°ÊÅØ
        title = paper.get('title', 'Êú™Áü•Ê†áÈ¢ò')
        authors = paper.get('authors', [])
        published = paper.get('published', '')[:10]
        topic = paper.get('topic_category', 'unknown')
        relevance_score = paper.get('relevance_score', 0)
        ai_summary = paper.get('ai_summary', paper.get('summary', ''))
        arxiv_url = paper.get('arxiv_url', '#')
        paper_id = paper.get('paper_id', '')
        matched_keywords = paper.get('matched_keywords', [])
        
        # üÜï ÊèêÂèñËÆ∫ÊñáË¥®ÈáèËØÑ‰º∞‰ø°ÊÅØ
        quality_score = paper.get('quality_score')
        quality_level = paper.get('quality_level')
        quality_reasoning = paper.get('quality_reasoning')
        
        # Ê†ºÂºèÂåñ‰ΩúËÄÖ
        authors_str = ', '.join(authors[:3])
        if len(authors) > 3:
            authors_str += f' Á≠â'
        
        # Ê†ºÂºèÂåñÂÖ≥ÈîÆËØç
        keywords_str = ', '.join(matched_keywords[:5]) if matched_keywords else 'Êó†'
        if len(matched_keywords) > 5:
            keywords_str += f' Á≠â'
        
        # ‰∏ªÈ¢òÊ†áÁ≠æÈÖçÁΩÆ
        topic_labels = {
            'image_denoising': 'üñºÔ∏è ÂõæÂÉèÂéªÂô™',
            'image_deraining': 'üåßÔ∏è ÂõæÂÉèÂéªÈõ®',
            'reinforcement_learning': 'ü§ñ Âº∫ÂåñÂ≠¶‰π†',
            'embodied_ai': 'ü¶æ ÂÖ∑Ë∫´Êô∫ËÉΩ',
            'computer_vision': 'üëÅÔ∏è ËÆ°ÁÆóÊú∫ËßÜËßâ',
            'deep_learning': 'üß† Ê∑±Â∫¶Â≠¶‰π†'
        }
        topic_label = topic_labels.get(topic, f'üìå {topic}')
        
        # üÜï ÁîüÊàêË¥®ÈáèËØÑ‰º∞ÂæΩÁ´†
        quality_badge_html = ""
        if quality_score is not None and quality_level:
            # Ê†πÊçÆËØÑÂàÜÁîüÊàêÊòüÁ∫ß
            stars = "‚≠ê" * min(quality_score, 10)
            
            # Ê†πÊçÆËØÑÂàÜÁ°ÆÂÆöÊ†∑Âºè
            if quality_score >= 9:
                badge_class = "quality-top"
                emoji = "üèÜ"
            elif quality_score >= 7:
                badge_class = "quality-excellent"
                emoji = "‚≠ê"
            elif quality_score >= 5:
                badge_class = "quality-good"
                emoji = "‚úÖ"
            elif quality_score >= 3:
                badge_class = "quality-normal"
                emoji = "üìù"
            else:
                badge_class = "quality-weak"
                emoji = "üìÑ"
            
            quality_badge_html = f'<span class="quality-badge {badge_class}">{emoji} {quality_level} ({quality_score}/10)</span>'
        
        # üÜï ÁîüÊàêËØÑ‰º∞ÁêÜÁî±Âå∫Âùó
        reasoning_html = ""
        if quality_reasoning:
            reasoning_html = f"""
                <div class="quality-reasoning">
                    <strong>üí° AIËØÑ‰º∞ÁêÜÁî±Ôºö</strong>{quality_reasoning}
                </div>
            """
        
        return f"""
            <div class="paper-card">
                <div>
                    <span class="paper-number">{index}</span>
                    <span class="paper-title">
                        <a href="{arxiv_url}" target="_blank">{title}</a>
                    </span>
                </div>
                
                <div class="paper-meta">
                    <span><strong>üìÖ ÂèëÂ∏ÉÔºö</strong>{published}</span>
                    <span><strong>üìÑ IDÔºö</strong>{paper_id}</span>
                </div>
                
                <div class="paper-authors">
                    ‚úçÔ∏è ‰ΩúËÄÖÔºö{authors_str}
                </div>
                
                <div style="margin: 10px 0;">
                    <span class="paper-topic">{topic_label}</span>
                    <span class="paper-score">Áõ∏ÂÖ≥ÊÄß: {relevance_score:.1%}</span>
                    {quality_badge_html}
                </div>
                
                <div class="paper-summary">
                    <strong>ü§ñ AIÊ†∏ÂøÉÊÄùÊÉ≥ÊÄªÁªìÔºö</strong><br>
                    {ai_summary}
                </div>
                
                {reasoning_html}
                
                <div class="paper-keywords">
                    <strong>üè∑Ô∏è ÂÖ≥ÈîÆËØçÔºö</strong>{keywords_str}
                </div>
                
                <a href="{arxiv_url}" target="_blank" class="paper-link">
                    üìñ Êü•ÁúãÂéüÊñá &rarr;
                </a>
            </div>
"""

    @staticmethod
    def get_footer() -> str:
        """
        ÁîüÊàêÈÇÆ‰ª∂Â∫ïÈÉ®
        
        Returns:
            HTMLÂ∫ïÈÉ®
        """
        return """
        </div>
        
        <div class="footer">
            <div class="divider"></div>
            <p>
                ËøôÊòØ‰∏Ä‰ªΩËá™Âä®ÁîüÊàêÁöÑArxivËÆ∫ÊñáÊó•Êä•„ÄÇ<br>
                Áî± <strong>Arxiv Mailbot</strong> È©±Âä®Ôºå‰ΩøÁî®DeepSeek AIÁîüÊàêËÆ∫ÊñáÊÄªÁªì‰∏éËØÑ‰º∞„ÄÇ<br>
                <a href="https://github.com/JiJiwjz/SamArM">È°πÁõÆÊ∫êÁ†Å</a> | 
                <a href="mailto:support@example.com">ÂèçÈ¶àÂª∫ËÆÆ</a>
            </p>
            <p style="margin-top: 10px; color: #ccc;">
                ¬© 2025 Arxiv Mailbot. Ëá™Âä®ÂåñËÆ∫ÊñáÊé®ËçêÁ≥ªÁªü
            </p>
        </div>
    </div>
</body>
</html>
"""

    @classmethod
    def generate_email_html(cls, papers: list, topic_stats: dict = None) -> str:
        """
        ÁîüÊàêÂÆåÊï¥ÁöÑÈÇÆ‰ª∂HTML
        
        Args:
            papers: ËÆ∫ÊñáÂàóË°®ÔºàÂ∑≤ÊéíÂ∫èÔºâ
            topic_stats: ‰∏ªÈ¢òÁªüËÆ°
        
        Returns:
            ÂÆåÊï¥ÁöÑHTMLÈÇÆ‰ª∂ÂÜÖÂÆπ
        """
        date_str = datetime.utcnow().strftime('%YÂπ¥%mÊúà%dÊó•')
        
        html = cls.get_header(date_str, len(papers), topic_stats)
        
        for i, paper in enumerate(papers, 1):
            html += cls.get_paper_card(i, paper)
        
        html += cls.get_footer()
        
        return html
